<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½å¤ªé˜³ç³» (DeepSeek éšæœºé¢˜åº“ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- åŸºç¡€è®¾ç½® --- */
        body { margin: 0; padding: 0; background-color: #050505; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; }
        .stars { position: absolute; width: 100%; height: 100%; background-image: radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)), radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)), radial-gradient(2px 2px at 50px 160px, #ddd, rgba(0,0,0,0)), radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0)), radial-gradient(2px 2px at 130px 80px, #fff, rgba(0,0,0,0)); background-size: 200px 200px; animation: twinkle 5s infinite; z-index: -1; }
        
        /* å¤ªé˜³ç³»å®¹å™¨ */
        .solar-system { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; transform-style: preserve-3d; transform: scale(0.8); transition: transform 0.5s ease; }
        .solar-system.shifted { transform: scale(0.7) translateX(-20%); }
        
        /* æ˜Ÿçƒæ ·å¼ */
        .sun { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle, #ffd200, #f7971e); border-radius: 50%; box-shadow: 0 0 40px #f7971e, 0 0 80px #ff6600; z-index: 100; cursor: pointer; pointer-events: auto; }
        .orbit { position: absolute; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: rotate linear infinite; pointer-events: none; z-index: 10; }
        .orbit.paused { animation-play-state: paused; }
        .planet { position: absolute; top: 50%; left: 0; transform: translate(-50%, -50%); border-radius: 50%; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; pointer-events: auto; z-index: 101; }
        .planet:hover { transform: translate(-50%, -50%) scale(1.5); z-index: 200; box-shadow: 0 0 15px white, inset -2px -2px 5px rgba(0,0,0,0.5); }
        .planet.active { box-shadow: 0 0 20px #00d2ff, inset -2px -2px 5px rgba(0,0,0,0.5); transform: translate(-50%, -50%) scale(1.3); }
        
        /* è¡Œæ˜Ÿå‚æ•° */
        .orbit-mercury { width: 100px; height: 100px; animation-duration: 4s; } .mercury { width: 10px; height: 10px; background: #a5a5a5; }
        .orbit-venus { width: 150px; height: 150px; animation-duration: 7s; } .venus { width: 14px; height: 14px; background: #e3bb76; }
        .orbit-earth { width: 210px; height: 210px; animation-duration: 10s; } .earth { width: 15px; height: 15px; background: #22a6b3; }
        .moon-orbit { position: absolute; top: 50%; left: 50%; width: 26px; height: 26px; transform: translate(-50%, -50%); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; animation: rotate 2s linear infinite; pointer-events: none; }
        .moon { position: absolute; top: 50%; left: 0; width: 4px; height: 4px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); }
        .orbit-mars { width: 270px; height: 270px; animation-duration: 15s; } .mars { width: 12px; height: 12px; background: #eb4d4b; }
        .orbit-jupiter { width: 380px; height: 380px; animation-duration: 30s; } .jupiter { width: 30px; height: 30px; background: #dcdde1; background-image: linear-gradient(#b0a597, #d4cfc7, #9c8e7e); }
        .orbit-saturn { width: 500px; height: 500px; animation-duration: 50s; } .saturn { width: 26px; height: 26px; background: #e1b12c; position: relative;}
        .saturn::before { content: ''; position: absolute; width: 40px; height: 10px; border: 4px solid rgba(199, 168, 114, 0.6); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-20deg); pointer-events: none; }
        .orbit-uranus { width: 600px; height: 600px; animation-duration: 70s; } .uranus { width: 20px; height: 20px; background: #686de0; }
        .orbit-neptune { width: 700px; height: 700px; animation-duration: 90s; } .neptune { width: 19px; height: 19px; background: #4834d4; }
        
        @keyframes rotate { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes twinkle { 0%, 100% { opacity: 0.8; } 50% { opacity: 0.4; } }
        
        /* UI é¢æ¿ */
        .ai-panel { position: fixed; right: -400px; top: 0; width: 380px; height: 100%; background: rgba(10, 15, 30, 0.9); backdrop-filter: blur(15px); border-left: 1px solid rgba(255,255,255,0.1); box-shadow: -5px 0 20px rgba(0,0,0,0.5); transition: right 0.4s ease-in-out; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; z-index: 1000; }
        .ai-panel.open { right: 0; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px; }
        .planet-title { font-size: 24px; font-weight: bold; color: #00d2ff; }
        .planet-title-group { display: flex; align-items: center; gap: 10px; }
        .voice-btn { background: none; border: 1px solid rgba(0, 210, 255, 0.5); color: #00d2ff; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
        .voice-btn:hover { background: rgba(0, 210, 255, 0.2); transform: scale(1.1); }
        .voice-btn.playing { animation: pulse 1s infinite; background: #00d2ff; color: #000; }
        .close-btn { background: none; border: none; color: rgba(255,255,255,0.5); font-size: 20px; cursor: pointer; }
        .chat-area { flex-grow: 1; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; display: flex; flex-direction: column; gap: 10px; }
        .chat-area::-webkit-scrollbar { width: 6px; }
        .chat-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .message { padding: 10px 15px; border-radius: 10px; font-size: 14px; line-height: 1.4; max-width: 85%; word-wrap: break-word; }
        .msg-user { background: #2b5278; align-self: flex-end; color: white; border-bottom-right-radius: 2px; }
        .msg-ai { background: rgba(255,255,255,0.1); align-self: flex-start; color: #e0e0e0; border-bottom-left-radius: 2px; border: 1px solid rgba(255,255,255,0.05); }
        .input-area { display: flex; gap: 10px; }
        .chat-input { flex-grow: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; padding: 10px; color: white; outline: none; font-family: inherit; }
        .chat-input:focus { border-color: #00d2ff; }
        .send-btn { background: #00d2ff; border: none; border-radius: 5px; width: 40px; color: #000; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        .send-btn:hover { background: #33dfff; }

        /* æŒ‰é’®ç»„ */
        .top-btn { position: absolute; top: 20px; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 30px; color: white; cursor: pointer; font-family: inherit; display: flex; align-items: center; gap: 10px; transition: all 0.3s; z-index: 500; }
        .top-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(2px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .fact-btn { left: 20px; }
        .settings-btn { right: 20px; }

        /* æµ‹éªŒåŒºåŸŸ */
        .quiz-container { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px; display: none; }
        .quiz-container.show { display: block; animation: fadeIn 0.5s; }
        .quiz-question { font-weight: bold; color: #ffd700; margin-bottom: 10px; font-size: 15px; }
        .quiz-options { display: flex; flex-direction: column; gap: 8px; }
        .quiz-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 8px; border-radius: 5px; cursor: pointer; text-align: left; transition: all 0.2s; }
        .quiz-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .quiz-btn.correct { background: rgba(40, 167, 69, 0.6); border-color: #28a745; }
        .quiz-btn.wrong { background: rgba(220, 53, 69, 0.6); border-color: #dc3545; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 10px; }
        .tool-btn { flex: 1; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #ccc; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.3s; }
        .tool-btn:hover { background: rgba(255, 255, 255, 0.2); color: white; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { background: rgba(10, 20, 40, 0.95); border: 1px solid #00d2ff; box-shadow: 0 0 30px rgba(0, 210, 255, 0.3); border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; text-align: center; transform: translateY(20px); transition: transform 0.3s ease; display: flex; flex-direction: column; gap: 15px; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal h2 { margin: 0 0 10px 0; color: #00d2ff; }
        .modal-input-group { text-align: left; }
        .modal-input-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #aaa; }
        .modal-input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #000; color: white; box-sizing: border-box; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .primary-btn { background: #00d2ff; color: #000; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .primary-btn:hover { background: #33dfff; }
        .secondary-btn { background: transparent; color: #ccc; border: 1px solid #555; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .secondary-btn:hover { background: rgba(255,255,255,0.1); }

        .loading-dots::after { content: '...'; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 210, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 210, 255, 0); } }
        
        @media (max-width: 768px) { .solar-system { transform: scale(0.5); } .solar-system.shifted { transform: scale(0.5); } .ai-panel { width: 100%; right: -100%; } .settings-btn { top: auto; bottom: 20px; right: 20px; } .fact-btn { top: 20px; left: 20px; } }
    </style>
</head>
<body>

    <div class="stars"></div>
    
    <button class="top-btn fact-btn" onclick="getCosmicFact()"><i class="fa-solid fa-wand-magic-sparkles" style="color: #ffd700;"></i><span id="fact-btn-text">å®‡å®™å†·çŸ¥è¯†</span></button>
    <button class="top-btn settings-btn" onclick="openSettings()"><i class="fa-solid fa-gear"></i> DeepSeek è®¾ç½®</button>

    <!-- å†·çŸ¥è¯† Modal -->
    <div class="modal-overlay" id="factModal"><div class="modal">
        <div style="font-size: 40px; color: #ffd700; margin-bottom: 20px;"><i class="fa-solid fa-star"></i></div>
        <div style="font-size: 18px; line-height: 1.6; color: #e0e0e0;" id="factContent">...</div>
        <div class="modal-footer" style="justify-content: center;"><button class="primary-btn" onclick="closeFactModal()">æ”¶åˆ°</button></div>
    </div></div>

    <!-- è®¾ç½® Modal -->
    <div class="modal-overlay" id="settingsModal"><div class="modal">
        <h2><i class="fa-solid fa-brain"></i> DeepSeek é…ç½®</h2>
        
        <div class="modal-input-group">
            <label>DeepSeek API Key (å·²å†…ç½®):</label>
            <input type="password" id="apiKeyInput" class="modal-input" placeholder="sk-..." value="sk-bf28c6d3ddfb4b88bc7b8d2b6efa0754">
        </div>

        <div class="modal-input-group">
            <label>æ¥å£åœ°å€ (é€‰å¡«, è§£å†³è·¨åŸŸé—®é¢˜):</label>
            <input type="text" id="baseUrlInput" class="modal-input" placeholder="https://api.deepseek.com">
            <div style="font-size: 12px; color: #eab308; margin-top: 5px; text-align: left;">
                <i class="fa-solid fa-triangle-exclamation"></i> <b>é‡è¦æç¤ºï¼š</b><br>
                å¦‚æœå‡ºç°â€œè¿æ¥å¤±è´¥â€æˆ– CORS é”™è¯¯ï¼Œè¯·å°è¯•å°†ä¸Šæ–¹åœ°å€æ”¹ä¸ºæ”¯æŒè·¨åŸŸçš„ä¸­è½¬åœ°å€ã€‚<br>
                ä¾‹å¦‚ï¼šæœ‰äº›å…¬ç›Šé¡¹ç›®æä¾›çš„ OpenAI æ ¼å¼ä¸­è½¬åœ°å€ã€‚
            </div>
        </div>

        <div class="modal-footer">
            <button class="secondary-btn" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button class="primary-btn" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div></div>

    <div class="solar-system" id="solarSystem">
        <div class="sun" onclick="selectPlanet('å¤ªé˜³', 'Sun', this)"></div>
        <div class="orbit orbit-mercury"><div class="planet mercury" onclick="selectPlanet('æ°´æ˜Ÿ', 'Mercury', this)"></div></div>
        <div class="orbit orbit-venus"><div class="planet venus" onclick="selectPlanet('é‡‘æ˜Ÿ', 'Venus', this)"></div></div>
        <div class="orbit orbit-earth"><div class="planet earth" onclick="selectPlanet('åœ°çƒ', 'Earth', this)"><div class="moon-orbit"><div class="moon"></div></div></div></div>
        <div class="orbit orbit-mars"><div class="planet mars" onclick="selectPlanet('ç«æ˜Ÿ', 'Mars', this)"></div></div>
        <div class="orbit orbit-jupiter"><div class="planet jupiter" onclick="selectPlanet('æœ¨æ˜Ÿ', 'Jupiter', this)"></div></div>
        <div class="orbit orbit-saturn"><div class="planet saturn" onclick="selectPlanet('åœŸæ˜Ÿ', 'Saturn', this)"></div></div>
        <div class="orbit orbit-uranus"><div class="planet uranus" onclick="selectPlanet('å¤©ç‹æ˜Ÿ', 'Uranus', this)"></div></div>
        <div class="orbit orbit-neptune"><div class="planet neptune" onclick="selectPlanet('æµ·ç‹æ˜Ÿ', 'Neptune', this)"></div></div>
    </div>

    <div class="ai-panel" id="aiPanel">
        <div class="panel-header">
            <div class="planet-title-group">
                <div class="planet-title" id="panelTitle">é€‰æ‹©æ˜Ÿçƒ</div>
                <button class="voice-btn" id="voiceBtn" onclick="playLastIntro()" title="æ’­æ”¾/åœæ­¢è¯­éŸ³"><i class="fa-solid fa-volume-high"></i></button>
            </div>
            <button class="close-btn" onclick="closePanel()">&times;</button>
        </div>
        <div class="toolbar"><button class="tool-btn" onclick="startQuiz()"><i class="fa-solid fa-graduation-cap"></i> çŸ¥è¯†æŒ‘æˆ˜</button></div>
        <div id="quizContainer" class="quiz-container"><div id="quizQuestion" class="quiz-question">é—®é¢˜åŠ è½½ä¸­...</div><div id="quizOptions" class="quiz-options"></div></div>
        <div class="chat-area" id="chatArea"><div class="message msg-ai">ä½ å¥½ï¼æˆ‘æ˜¯ç”± DeepSeek é©±åŠ¨çš„æ˜Ÿé™…å‘å¯¼ã€‚Key å·²è‡ªåŠ¨åŠ è½½ï¼Œè¯·ç‚¹å‡»ä»»æ„æ˜Ÿçƒå¼€å§‹å¯¹è¯ã€‚</div></div>
        <div class="input-area"><input type="text" class="chat-input" id="chatInput" placeholder="å‘å®ƒæé—®..." onkeypress="handleKeyPress(event)"><button class="send-btn" id="sendBtn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button></div>
    </div>

    <script>
        // é…ç½® - å·²ç¡¬ç¼–ç æ‚¨çš„ Key
        let config = {
            apiKey: 'sk-bf28c6d3ddfb4b88bc7b8d2b6efa0754',
            baseUrl: localStorage.getItem('ds_baseUrl') || 'https://api.deepseek.com'
        };

        let currentPlanetName = "";
        let currentIntroText = "";
        let isSpeaking = false;

        // --- UI è®¾ç½® ---
        function openSettings() {
            document.getElementById('apiKeyInput').value = config.apiKey;
            document.getElementById('baseUrlInput').value = config.baseUrl;
            document.getElementById('settingsModal').classList.add('active');
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            let url = document.getElementById('baseUrlInput').value.trim() || 'https://api.deepseek.com';
            url = url.replace(/\/$/, ""); // å»æ‰æœ«å°¾æ–œæ 
            
            if(!key) { alert("API Key ä¸èƒ½ä¸ºç©ºï¼"); return; }
            
            config.apiKey = key;
            config.baseUrl = url;
            // ä»ç„¶ä¿å­˜åˆ°æœ¬åœ°ï¼Œä»¥ä¾¿è®°ä½ç”¨æˆ·çš„è‡ªå®šä¹‰ BaseURL
            localStorage.setItem('ds_baseUrl', url);
            
            document.getElementById('settingsModal').classList.remove('active');
            alert("âœ… è®¾ç½®å·²ä¿å­˜ï¼");
        }

        // --- DeepSeek API è°ƒç”¨ (Fetch) ---
        async function callDeepSeek(prompt, systemPrompt = "", jsonMode = false) {
            const url = `${config.baseUrl}/chat/completions`;
            
            const headers = {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${config.apiKey}`
            };

            const body = {
                model: "deepseek-chat",
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: prompt }
                ],
                stream: false
            };

            if (jsonMode) {
                body.response_format = { type: "json_object" };
            }

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    const msg = err.error?.message || response.statusText;
                    console.error("API Error:", err);
                    
                    if (response.status === 402) {
                        return "ğŸš« ä½™é¢ä¸è¶³ (402)ã€‚æ‚¨çš„ DeepSeek è´¦æˆ·éœ€è¦å……å€¼ã€‚";
                    }
                    // æ£€æµ‹ CORS é”™è¯¯
                    return `âš ï¸ API æŠ¥é”™ (${response.status}): ${msg}`;
                }

                const data = await response.json();
                return data.choices[0].message.content;

            } catch (e) {
                console.error("Fetch Error:", e);
                // è¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯ç±»å‹ï¼šç½‘ç»œä¸é€š æˆ– CORS æ‹¦æˆª
                return "ğŸš« è¿æ¥å¤±è´¥ (Network/CORS)ã€‚\næµè§ˆå™¨æ‹¦æˆªäº†å¯¹ DeepSeek çš„ç›´æ¥è¯·æ±‚ã€‚\nè¯·å°è¯•åœ¨è®¾ç½®ä¸­æ›´æ¢â€œæ¥å£åœ°å€â€ä¸ºæ”¯æŒè·¨åŸŸçš„ä¸­è½¬åœ°å€ (Base URL)ã€‚";
            }
        }

        async function testConnection() {
            const tempKey = document.getElementById('apiKeyInput').value.trim();
            if(!tempKey) { alert("è¯·å…ˆå¡«å†™ Key"); return; }
            
            // ä¸´æ—¶ä¿å­˜ç”¨äºæµ‹è¯•
            const oldKey = config.apiKey;
            config.apiKey = tempKey;
            
            try {
                const res = await callDeepSeek("Hi", "Reply 'OK' if connected.");
                if (res.includes("OK") || !res.includes("é”™è¯¯") && !res.includes("å¤±è´¥")) {
                    alert("ğŸ‰ è¿æ¥æˆåŠŸï¼");
                } else {
                    alert(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥ã€‚\n${res}`);
                }
            } finally {
                config.apiKey = oldKey; // æ¢å¤
            }
        }

        // --- åŸç”Ÿè¯­éŸ³åˆæˆ (TTS) ---
        function speak(text) {
            if (!window.speechSynthesis) { alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½"); return; }
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN';
            const voices = window.speechSynthesis.getVoices();
            const zh = voices.find(v => v.lang.includes('zh'));
            if (zh) u.voice = zh;

            u.onstart = () => { document.getElementById('voiceBtn').classList.add('playing'); isSpeaking = true; };
            u.onend = () => { document.getElementById('voiceBtn').classList.remove('playing'); isSpeaking = false; };
            window.speechSynthesis.speak(u);
        }

        function playLastIntro() {
            if (!currentIntroText) return;
            if (isSpeaking) { window.speechSynthesis.cancel(); isSpeaking = false; }
            else { speak(currentIntroText); }
        }

        // --- ä¸šåŠ¡é€»è¾‘ ---
        function selectPlanet(name, englishName, element) {
            currentPlanetName = name; currentIntroText = "";
            document.getElementById('panelTitle').textContent = name;
            
            document.querySelectorAll('.orbit').forEach(el => el.classList.add('paused'));
            document.querySelectorAll('.planet').forEach(el => el.classList.remove('active'));
            document.querySelector('.sun').classList.remove('active');
            element.classList.add('active');
            
            document.getElementById('aiPanel').classList.add('open');
            document.getElementById('solarSystem').classList.add('shifted');
            document.getElementById('quizContainer').classList.remove('show');
            document.getElementById('chatArea').innerHTML = '';
            
            generateIntro(name);
        }

        function closePanel() {
            document.getElementById('aiPanel').classList.remove('open');
            document.getElementById('solarSystem').classList.remove('shifted');
            document.querySelectorAll('.orbit').forEach(el => el.classList.remove('paused'));
            document.querySelectorAll('.planet').forEach(el => el.classList.remove('active'));
            document.querySelector('.sun').classList.remove('active');
            window.speechSynthesis.cancel();
            isSpeaking = false;
        }

        function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }

        function appendMessage(text, sender) {
            const area = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = `message ${sender === 'user' ? 'msg-user' : 'msg-ai'}`;
            div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        async function generateIntro(name) {
            appendMessage('<span class="loading-dots">DeepSeek æ€è€ƒä¸­</span>', 'ai');
            const prompt = `ä½ ç°åœ¨æ˜¯å¤ªé˜³ç³»ä¸­çš„${name}ã€‚è¯·ç”¨ç¬¬ä¸€äººç§°å’Œæˆ‘æ‰“æ‹›å‘¼ã€‚æ€§æ ¼è¦ç¬¦åˆè¯¥æ˜Ÿçƒçš„ç§‘å­¦ç‰¹å¾ï¼ˆä¾‹å¦‚ç«æ˜Ÿæ˜¯åšæ¯…çš„ï¼Œé‡‘æ˜Ÿæ˜¯çƒ­æƒ…çš„ï¼‰ã€‚é™åˆ¶50å­—ä»¥å†…ã€‚`;
            const res = await callDeepSeek("æ‰“ä¸ªæ‹›å‘¼", prompt);
            currentIntroText = res;
            const area = document.getElementById('chatArea');
            if (area.lastChild.innerHTML.includes('loading')) area.removeChild(area.lastChild);
            appendMessage(res, 'ai');
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentPlanetName) return;
            
            appendMessage(text, 'user');
            input.value = '';
            
            const loadDiv = document.createElement('div');
            loadDiv.className = 'message msg-ai loading-dots';
            loadDiv.textContent = 'æ€è€ƒä¸­';
            document.getElementById('chatArea').appendChild(loadDiv);
            
            const sys = `ä½ ç°åœ¨æ˜¯${currentPlanetName}ã€‚è¯·ä¿æŒè§’è‰²è®¾å®šï¼Œç”¨ç¬¬ä¸€äººç§°å›ç­”ç”¨æˆ·å…³äºä½ çš„é—®é¢˜ã€‚`;
            const res = await callDeepSeek(text, sys);
            
            document.getElementById('chatArea').removeChild(loadDiv);
            appendMessage(res, 'ai');
        }

        async function startQuiz() {
            const container = document.getElementById('quizContainer');
            container.classList.add('show');
            document.getElementById('quizQuestion').textContent = "é¢˜ç›®ç”Ÿæˆä¸­...";
            document.getElementById('quizOptions').innerHTML = "";
            
            // éšæœºå› å­é€»è¾‘ (æ ¸å¿ƒä¿®å¤éƒ¨åˆ†)
            const topics = ["ç‰©ç†ç‰¹å¾", "æ¢ç´¢å†å²", "å«æ˜Ÿ", "å¤§æ°”å±‚", "è½¨é“ç‰¹æ€§", "ç¥è¯ä¼ è¯´", "è¶£å‘³å†·çŸ¥è¯†", "åœ°è´¨ç»“æ„"];
            const randomTopic = topics[Math.floor(Math.random() * topics.length)];
            const randomSeed = Math.floor(Math.random() * 1000);

            const prompt = `ç”Ÿæˆä¸€é“å…³äº${currentPlanetName}çš„å•é¡¹é€‰æ‹©é¢˜ã€‚
            è¦æ±‚ï¼š
            1. ä¾§é‡äºã€${randomTopic}ã€‘æ–¹é¢ã€‚
            2. éš¾åº¦éšæœºã€‚
            3. å¿…é¡»è¿”å›çº¯ JSON æ ¼å¼ï¼š{"question": "...", "options": ["A", "B", "C"], "answerIndex": 0}ã€‚
            4. éšæœºç§å­ï¼š${randomSeed}`;
            
            try {
                let res = await callDeepSeek(prompt, "ä½ æ˜¯ä¸€ä¸ªJSONç”Ÿæˆå™¨", true);
                res = res.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(res);
                
                document.getElementById('quizQuestion').textContent = data.question;
                const opts = document.getElementById('quizOptions');
                opts.innerHTML = "";
                
                data.options.forEach((opt, idx) => {
                    const btn = document.createElement('div');
                    btn.className = 'quiz-btn';
                    btn.textContent = opt;
                    btn.onclick = () => {
                        const all = opts.children;
                        for(let b of all) b.onclick = null;
                        if (idx === data.answerIndex) { btn.classList.add('correct'); btn.innerHTML += " âœ…"; }
                        else { btn.classList.add('wrong'); all[data.answerIndex].classList.add('correct'); }
                    };
                    opts.appendChild(btn);
                });
            } catch (e) {
                document.getElementById('quizQuestion').textContent = "å‡ºé¢˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚";
            }
        }

        async function getCosmicFact() {
            const btn = document.querySelector('.fact-btn');
            const modal = document.getElementById('factModal');
            const content = document.getElementById('factContent');
            
            btn.style.pointerEvents = 'none';
            document.getElementById('fact-btn-text').textContent = "è·å–ä¸­...";
            modal.classList.add('active');
            content.innerHTML = '<span class="loading-dots">DeepSeek æ­£åœ¨æ£€ç´¢å®‡å®™çŸ¥è¯†</span>';
            
            const res = await callDeepSeek("ç»™æˆ‘è®²ä¸€ä¸ªç®€çŸ­çš„ã€ä»¤äººéœ‡æƒŠçš„å®‡å®™å†·çŸ¥è¯†ã€‚");
            content.innerHTML = res;
            
            btn.style.pointerEvents = 'auto';
            document.getElementById('fact-btn-text').textContent = "å®‡å®™å†·çŸ¥è¯†";
        }

        function closeFactModal() { document.getElementById('factModal').classList.remove('active'); }
        function resizeSystem() {
            const system = document.querySelector('.solar-system');
            const minDimension = Math.min(window.innerWidth, window.innerHeight);
            let scale = 0.8;
            if (minDimension < 750) scale = minDimension / 800;
            system.style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', resizeSystem);
    </script>
</body>
</html>